# Blender Add-on: Pose-Editor Design

## 1. Overview
This document outlines the design for a Blender add-on that provides an end-to-end pipeline for editing motion capture data. The workflow starts with editing 2D pose data captured from video, progresses to 3D reconstruction, and finishes with a fully rigged and animated 3D character.

The add-on is designed to handle complex scenarios with multiple camera angles and multiple people. The entire pipeline is centered around the concept of a **"Real Person"**, a primary data object that links together the 2D, 3D, and final armature data for a single individual. The add-on will heavily integrate with **Pose2Sim**, a third-party Python library, to handle 3D triangulation, data filtering, and body measurement estimation.

## 2. The "Real Person" Concept
The "Real Person" is the central, cross-cutting entity in the application. When a user creates a Real Person (e.g., "Alice"), they are creating a master data container that will be populated throughout the workflow. This single entity will own and link together all of the following data components:

-   **Stitched 2D Marker Sets:** A collection of 2D marker sets, one for each camera view where the person is present. Each set is the result of the 2D identity stitching process.
-   **Triangulated 3D Marker Set:** A single set of animated 3D markers, generated by triangulating the various 2D marker sets.
-   **Body Measurements:** A data structure holding the person's estimated body measurements, calculated from the 3D markers and editable by the user. These can be saved and reused.
-   **Final 3D Armature:** The final, scaled, and rigged 3D character armature that is animated by the 3D markers.

This structure ensures that all data associated with a single performer is kept organized and connected from the beginning of the pipeline to the end.

## 3. Core Workflows & Requirements

### 3.1. 2D Pose Editing
- **Multi-Camera/Multi-Person:** Support loading multiple camera views (video + 2D pose data) and provide a workflow for stitching fragmented person tracks into continuous "Real Person" entities.
- **Synced Video:** Display the source video as a synchronized background for direct visual reference during editing.
- **Blender-Native Editing:** All 2D marker data should be editable using standard Blender tools (3D Viewport, Graph Editor, Dope Sheet).
- **Hierarchical Tools:** Provide tools for selecting and manipulating entire limbs (e.g., "Select Children" command that also sets the pivot point).

### 3.2. 3D Motion Capture Pipeline
- **Camera Calibration:** Load and manage camera calibration data (intrinsics/extrinsics in OpenCV format) required for 3D reconstruction.
- **3D Triangulation:** Use `Pose2Sim` to triangulate the corrected 2D marker data from multiple views into a 3D pose. This process is iterative.
- **3D Data Filtering:** Integrate `Pose2Sim`'s filters (e.g., Butterworth, Kalman) to process the raw 3D marker animation curves.
- **Armature Fitting:** Provide a workflow to scale a standard armature to a person's estimated body measurements (calculated via `Pose2Sim`) and then rig it to be driven by the 3D markers using Blender's IK constraints.
- **Finalization:** Bake the IK-driven animation onto the armature and provide export options.

## 4. Detailed Pipeline Stages

### 4.1. 2D Identity Stitching
This phase builds the initial 2D data for a "Real Person".
- **Initial Visualization:** All raw tracks are loaded, each with its own annotated skeleton and markers.
- **"Real Person" Creation:** The user creates a "Real Person" entity, which serves as the master container for that individual's data.
- **Stitching via Keyframed Index:** A custom property (`active_track_index`) on the Real Person's 2D armature (for a specific view) is keyframed over time to dynamically switch between the raw tracks used as the data source.

### 4.2. 2D Editing and Interaction
- **Manual Keyframing:** Moving a marker automatically sets its `likelihood` to 1.0.
- **Occlusions:** Users can keyframe a `visible` property to mark markers as occluded.
- **Hierarchical Posing:** A "Select Children" command selects a limb and sets the pivot to the root joint for intuitive rotation.

### 4.3. Camera Calibration Management
- **Separation of Concerns:** Calibration data is managed separately from pose data, allowing calibrations to be reused across projects and sessions.
- **Data Structure:**
    - An **Extrinsics** file defines the positions of all cameras in a session.
    - Each camera in the Extrinsics file references an **Intrinsics** file.
    - Each 2D pose data set loaded into the project is linked to a specific camera from the active Extrinsics set.
- **UI:** The add-on will provide a panel for loading and managing these calibration files.

### 4.4. 3D Triangulation
- **Engine:** Uses a function from the `Pose2Sim` library.
- **Inputs:** The collection of stitched 2D marker sets belonging to a "Real Person" and the corresponding camera calibration data.
- **Process:** The user selects a "Real Person" to triangulate. The add-on gathers the 2D data from all associated camera views and passes it to `Pose2Sim`.
- **Output:** A set of 3D markers are generated and associated with the selected "Real Person". Metadata (reprojection error, contributing views) is stored as custom properties on each 3D marker.
- **Iterative Workflow:** The user can review the 3D output, go back to the 2D views to correct markers, and then re-run triangulation.

### 4.5. 3D Data Filtering
- **Engine:** Uses filtering functions from `Pose2Sim`.
- **Process:** The user selects a "Real Person's" 3D marker set and applies one or more filters.
- **Reversibility:** The original, unfiltered f-curves are stored, allowing the user to revert the filtering operation.

### 4.6. Armature Fitting and Rigging
1.  **Armature Scaling:**
    *   **Measurement Estimation:** Use `Pose2Sim` to estimate body measurements from the "Real Person's" 3D marker data.
    *   **Data Association:** These measurements are stored as part of the "Real Person" entity and can be saved/loaded independently.
    *   **Application:** The user selects a target armature, and the add-on scales its bones to match the person's measurements.
2.  **IK Rigging:**
    *   The add-on automatically creates an IK rig on the scaled armature, targeting the "Real Person's" 3D markers.

### 4.7. Finalization
- **Baking:** The user bakes the animation for a "Real Person", transferring the motion from the IK rig to the deforming bones of the final armature.
- **Export:** The baked armature can be exported.

## 5. Overall Key Use Case Flow
1.  **Project Setup:** Load camera views and camera calibration files.
2.  **2D Stitching & Editing:** Create "Real Person" entities. For each person, stitch and edit their 2D marker data in all relevant camera views.
3.  **3D Triangulation:** For each "Real Person", run triangulation on their collected 2D data to generate their 3D marker set.
4.  **Iterative 3D/2D Refinement:** Review the 3D markers. If errors exist, go back to the 2D views for that person, fix the markers, and re-triangulate.
5.  **3D Filtering:** Apply smoothing filters to the "Real Person's" 3D marker animation.
6.  **Armature Scaling:** For each "Real Person", generate/load their body measurements and scale a target armature.
7.  **IK Rigging:** Create the IK rig for each person's armature, linking it to their 3D markers.
8.  **Baking & Export:** Bake the final animation onto the armatures and export.